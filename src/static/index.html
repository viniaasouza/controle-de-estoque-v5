<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Etiquetas para Restaurantes</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --verde-oliva: #556B2F;
            --marrom-terracota: #C37F6A;
            --bege-claro: #F5F5DC;
            --branco: #FFFFFF;
            --amarelo-mostarda: #FFD700;
            --cinza-claro: #f5f5f5;
            --cinza-medio: #e0e0e0;
            --texto-escuro: #333333;
            --sombra-padrao: 0 4px 15px rgba(0, 0, 0, 0.1);
            --borda-radius: 8px;
            --espacamento-secao: 60px;
            --espacamento-interno: 30px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            color: var(--texto-escuro);
            line-height: 1.6;
            background-color: var(--bege-claro);
            overflow-x: hidden;
        }

        /* HEADER */
        .header {
            background-color: var(--verde-oliva);
            color: var(--branco);
            padding: 20px 0;
            text-align: center;
        }

        .logo {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tagline {
            font-size: 1.2rem;
            font-weight: 400;
            margin-bottom: 10px;
        }

        /* HERO SECTION */
        .hero {
            background-color: var(--branco);
            padding: var(--espacamento-interno);
            margin-top: 20px;
        }

        .hero-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 40px;
        }

        .hero-content {
            flex: 1;
            min-width: 300px;
        }

        .hero-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 2.5rem;
            text-transform: uppercase;
            color: var(--verde-oliva);
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .hero-subtitle {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: var(--marrom-terracota);
        }

        .hero-image {
            flex: 1;
            min-width: 300px;
            text-align: center;
        }

        .hero-image img {
            max-width: 100%;
            height: auto;
            border-radius: var(--borda-radius);
            box-shadow: var(--sombra-padrao);
        }

        .image-placeholder {
            width: 100%;
            height: 250px;
            background-color: var(--cinza-medio);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #777;
            font-style: italic;
            border-radius: var(--borda-radius);
            text-align: center;
            padding: 20px;
        }

        /* BENEFÍCIOS */
        .beneficios {
            padding: var(--espacamento-interno);
            background-color: var(--bege-claro);
            margin-top: var(--espacamento-secao);
        }

        .beneficios-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .section-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 2rem;
            color: var(--verde-oliva);
            text-align: center;
            margin-bottom: 40px;
            text-transform: uppercase;
        }

        .beneficios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 30px;
        }

        .beneficio-card {
            background-color: var(--branco);
            border-radius: var(--borda-radius);
            padding: 25px;
            box-shadow: var(--sombra-padrao);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .beneficio-card:hover {
            transform: translateY(-5px);
        }

        .beneficio-icon {
            font-size: 2.5rem;
            color: var(--amarelo-mostarda);
            margin-bottom: 15px;
        }

        .beneficio-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--verde-oliva);
            margin-bottom: 15px;
        }

        .beneficio-text {
            color: var(--texto-escuro);
            font-size: 1rem;
        }

        /* FORMULÁRIO PRINCIPAL */
        .formulario-section {
            background-color: var(--marrom-terracota);
            padding: var(--espacamento-interno);
            margin-top: var(--espacamento-secao);
            color: var(--branco);
        }

        .formulario-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            gap: 40px;
        }

        .formulario-content {
            flex: 1;
            min-width: 300px;
        }

        .formulario-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 2rem;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        .formulario-subtitle {
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .formulario-steps {
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .step-number {
            background-color: var(--amarelo-mostarda);
            color: var(--texto-escuro);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-text {
            font-size: 1.1rem;
        }

        .formulario-form {
            flex: 1;
            min-width: 300px;
            background-color: var(--branco);
            border-radius: var(--borda-radius);
            padding: 30px;
            box-shadow: var(--sombra-padrao);
        }

        .form-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--verde-oliva);
            margin-bottom: 25px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--verde-oliva);
        }

        input[type="text"],
        input[type="date"],
        input[type="password"],
        input[type="email"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--cinza-medio);
            border-radius: var(--borda-radius);
            font-family: 'Open Sans', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="password"]:focus,
        input[type="email"]:focus,
        select:focus {
            border-color: var(--amarelo-mostarda);
            outline: none;
        }

        .btn {
            display: inline-block;
            background-color: var(--amarelo-mostarda);
            color: var(--texto-escuro);
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            text-transform: uppercase;
            padding: 15px 25px;
            border: none;
            border-radius: var(--borda-radius);
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            text-align: center;
        }

        .btn:hover {
            background-color: #e6c200;
        }

        .btn-secondary {
            background-color: var(--marrom-terracota);
            color: var(--branco);
        }

        .btn-secondary:hover {
            background-color: #b06d57;
        }

        .btn-danger {
            background-color: #d9534f;
            color: var(--branco);
        }

        .btn-danger:hover {
            background-color: #c9302c;
        }

        /* PRÉ-DEFINIÇÕES */
        .predefinicoes {
            padding: var(--espacamento-interno);
            background-color: var(--branco);
            margin-top: var(--espacamento-secao);
        }

        .predefinicoes-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .predefinicoes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .predefinicao-item {
            background-color: var(--cinza-claro);
            border-radius: var(--borda-radius);
            padding: 20px;
            box-shadow: var(--sombra-padrao);
            display: flex;
            flex-direction: column;
        }

        .predefinicao-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .predefinicao-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--verde-oliva);
        }

        .predefinicao-details {
            margin-bottom: 20px;
            color: var(--texto-escuro);
        }

        .predefinicao-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        .predefinicao-actions button {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .predefinicao-form {
            background-color: var(--cinza-claro);
            border-radius: var(--borda-radius);
            padding: 25px;
            box-shadow: var(--sombra-padrao);
        }

        .predefinicao-form-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--verde-oliva);
            margin-bottom: 20px;
            text-align: center;
        }

        /* LOGIN */
        .login-section {
            background-color: var(--branco);
            padding: var(--espacamento-interno);
            margin-top: var(--espacamento-secao);
        }

        .login-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .login-form {
            background-color: var(--cinza-claro);
            border-radius: var(--borda-radius);
            padding: 30px;
            box-shadow: var(--sombra-padrao);
        }

        .login-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            color: var(--verde-oliva);
            margin-bottom: 25px;
            text-align: center;
        }

        .login-subtitle {
            text-align: center;
            margin-bottom: 25px;
            color: var(--texto-escuro);
        }

        .auth-links {
            margin-top: 20px;
            text-align: center;
        }

        .auth-links a {
            color: var(--verde-oliva);
            text-decoration: none;
            font-weight: 600;
        }

        .auth-links a:hover {
            text-decoration: underline;
        }

        /* USER MENU */
        .user-menu {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--verde-oliva);
            color: var(--branco);
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            background-color: var(--amarelo-mostarda);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: var(--texto-escuro);
            font-weight: bold;
        }

        .user-name {
            font-weight: 600;
        }

        .logout-btn {
            background-color: transparent;
            border: 1px solid var(--branco);
            color: var(--branco);
            padding: 5px 15px;
            border-radius: var(--borda-radius);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background-color: var(--branco);
            color: var(--verde-oliva);
        }

        /* MENSAGENS */
        .message {
            padding: 15px;
            border-radius: var(--borda-radius);
            margin-top: 20px;
            text-align: center;
        }

        .success {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }

        .error {
            background-color: #f2dede;
            color: #a94442;
            border: 1px solid #ebccd1;
        }

        .info {
            background-color: #d9edf7;
            color: #31708f;
            border: 1px solid #bce8f1;
        }

        /* FOOTER */
        .footer {
            background-color: var(--verde-oliva);
            color: var(--branco);
            padding: 30px 0;
            text-align: center;
            margin-top: var(--espacamento-secao);
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-text {
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--branco);
            border-radius: var(--borda-radius);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--sombra-padrao);
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--verde-oliva);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--texto-escuro);
        }

        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            .hero-container,
            .formulario-container {
                flex-direction: column;
            }

            .beneficios-grid {
                grid-template-columns: 1fr;
            }

            .predefinicoes-grid {
                grid-template-columns: 1fr;
            }

            .hero-title,
            .formulario-title,
            .section-title {
                font-size: 1.8rem;
            }

            .logo {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- USER MENU (Visível apenas quando logado) -->
    <div id="userMenu" class="user-menu" style="display: none;">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar"></div>
            <span class="user-name" id="userName">Usuário</span>
        </div>
        <button id="logoutBtn" class="logout-btn">Sair</button>
    </div>

    <!-- HEADER -->
    <header class="header">
        <div class="logo">Etiquetas Pro</div>
        <div class="tagline">Sistema de Etiquetagem para Restaurantes</div>
    </header>

    <!-- LOGIN SECTION (Visível apenas quando não logado) -->
    <section id="loginSection" class="login-section" style="display: none;">
        <div class="login-container">
            <form id="loginForm" class="login-form">
                <h2 class="login-title">Acesso ao Sistema</h2>
                <p class="login-subtitle">Entre com suas credenciais para acessar o sistema de etiquetas</p>
                
                <div class="form-group">
                    <label for="username">Nome de Usuário:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn">Entrar</button>
                <div id="loginMessageArea" class="message" style="display: none;"></div>
                <div class="auth-links">
                    <p>Não tem acesso? Entre em contato com o administrador do sistema.</p>
                </div>
            </form>
        </div>
    </section>

    <!-- CONTEÚDO PRINCIPAL (Visível apenas quando logado) -->
    <div id="mainContent" style="display: none;">
        <!-- HERO SECTION -->
        <section class="hero">
            <div class="hero-container">
                <div class="hero-content">
                    <h1 class="hero-title">CRIE, PERSONALIZE, IMPRIMA, CONTROLE!</h1>
                    <p class="hero-subtitle">Com o nosso sistema, você gerencia tudo de forma simples: crie etiquetas personalizadas, controle validades e garanta a qualidade dos seus produtos.</p>
                    <a href="#formulario" class="btn">Comece Agora</a>
                </div>
                <div class="hero-image">
                    <div class="image-placeholder">
                        <p>Imagem de alta qualidade: Etiquetas em embalagens de alimentos em um restaurante profissional</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- BENEFÍCIOS -->
        <section class="beneficios">
            <div class="beneficios-container">
                <h2 class="section-title">Benefícios</h2>
                <div class="beneficios-grid">
                    <div class="beneficio-card">
                        <div class="beneficio-icon">
                            <i class="fas fa-print"></i>
                        </div>
                        <h3 class="beneficio-title">Impressão Rápida</h3>
                        <p class="beneficio-text">Gere e imprima etiquetas em segundos, otimizando o tempo da sua equipe.</p>
                    </div>
                    <div class="beneficio-card">
                        <div class="beneficio-icon">
                            <i class="fas fa-tags"></i>
                        </div>
                        <h3 class="beneficio-title">Múltiplos Tamanhos</h3>
                        <p class="beneficio-text">Escolha entre diferentes tamanhos de etiquetas para atender às suas necessidades.</p>
                    </div>
                    <div class="beneficio-card">
                        <div class="beneficio-icon">
                            <i class="fas fa-save"></i>
                        </div>
                        <h3 class="beneficio-title">Pré-definições</h3>
                        <p class="beneficio-text">Salve suas configurações mais usadas para agilizar o processo diário.</p>
                    </div>
                    <div class="beneficio-card">
                        <div class="beneficio-icon">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <h3 class="beneficio-title">Lote Automático</h3>
                        <p class="beneficio-text">Geração automática de lotes para melhor rastreabilidade dos seus produtos.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- FORMULÁRIO PRINCIPAL -->
        <section id="formulario" class="formulario-section">
            <div class="formulario-container">
                <div class="formulario-content">
                    <h2 class="formulario-title">Como Funciona</h2>
                    <p class="formulario-subtitle">Gerar etiquetas nunca foi tão fácil. Siga os passos:</p>
                    <div class="formulario-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div class="step-text">Preencha o nome do produto</div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-text">Defina as datas de fabricação e validade</div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-text">Escolha o tamanho da etiqueta</div>
                        </div>
                        <div class="step">
                            <div class="step-number">4</div>
                            <div class="step-text">Clique em gerar e baixe seu PDF</div>
                        </div>
                    </div>
                    <p>Você também pode usar uma pré-definição para agilizar o processo!</p>
                </div>
                <div class="formulario-form">
                    <h3 class="form-title">Criar Nova Etiqueta</h3>
                    <form id="etiquetaForm">
                        <div class="form-group">
                            <label for="nome_produto">Nome do Produto:</label>
                            <input type="text" id="nome_produto" name="nome_produto" required>
                        </div>
                        <div class="form-group">
                            <label for="data_fabricacao">Data de Fabricação:</label>
                            <input type="date" id="data_fabricacao" name="data_fabricacao" required>
                        </div>
                        <div class="form-group">
                            <label for="data_validade">Data de Validade:</label>
                            <input type="date" id="data_validade" name="data_validade" required>
                        </div>
                        <div class="form-group">
                            <label for="classificacao">Classificação do Item:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="classificacao" value="Seco" required>
                                    <span class="radio-label">Seco</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="classificacao" value="Resfriado" checked required>
                                    <span class="radio-label">Resfriado</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="classificacao" value="Congelado" required>
                                    <span class="radio-label">Congelado</span>
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tamanho_etiqueta">Tamanho da Etiqueta:</label>
                            <select id="tamanho_etiqueta" name="tamanho_etiqueta" required>
                                <option value="50x30">50mm x 30mm</option>
                                <option value="80x50" selected>80mm x 50mm (Padrão)</option>
                                <option value="100x50">100mm x 50mm</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">Gerar e Baixar Etiqueta PDF</button>
                    </form>
                    <div id="messageArea" class="message" style="display: none;"></div>
                </div>
            </div>
        </section>

        <!-- PRÉ-DEFINIÇÕES -->
        <section class="predefinicoes">
            <div class="predefinicoes-container">
                <h2 class="section-title">Pré-definições de Etiquetas</h2>
                <div id="listaPredefinicoes" class="predefinicoes-grid">
                    <p>Carregando pré-definições...</p>
                </div>
                
                <div class="predefinicao-form">
                    <h3 class="predefinicao-form-title">Criar/Editar Pré-definição</h3>
                    <form id="predefinicaoForm">
                        <input type="hidden" id="predefinicao_id" name="predefinicao_id">
                        <div class="form-group">
                            <label for="nome_predefinicao">Nome da Pré-definição:</label>
                            <input type="text" id="nome_predefinicao" name="nome_predefinicao" required>
                        </div>
                        <div class="form-group">
                            <label for="predef_nome_produto">Nome do Produto (Pré-definido):</label>
                            <input type="text" id="predef_nome_produto" name="predef_nome_produto" required>
                        </div>
                        <div class="form-group">
                            <label for="predef_tamanho_etiqueta">Tamanho da Etiqueta (Pré-definido):</label>
                            <select id="predef_tamanho_etiqueta" name="predef_tamanho_etiqueta" required>
                                <option value="50x30">50mm x 30mm</option>
                                <option value="80x50" selected>80mm x 50mm (Padrão)</option>
                                <option value="100x50">100mm x 50mm</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-secondary">Salvar Pré-definição</button>
                        <button type="button" id="cancelEditPredefinicao" class="btn btn-danger" style="display:none; margin-top:10px;">Cancelar Edição</button>
                    </form>
                    <div id="messagePredefinicaoArea" class="message" style="display: none;"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <div class="footer-content">
            <p class="footer-text">&copy; 2025 Etiquetas Pro. Todos os direitos reservados.</p>
            <p class="footer-text">Sistema de Etiquetagem para Restaurantes</p>
        </div>
    </footer>

    <!-- SCRIPTS -->
    <script src="/js/etiqueta-form.js"></script>
    <script>
        const API_URL = "/api";
        const AUTH_API_URL = "/api";
        
        // Elementos DOM
        const loginSection = document.getElementById("loginSection");
        const mainContent = document.getElementById("mainContent");
        const userMenu = document.getElementById("userMenu");
        const userAvatar = document.getElementById("userAvatar");
        const userName = document.getElementById("userName");
        const logoutBtn = document.getElementById("logoutBtn");
        const loginForm = document.getElementById("loginForm");
        const loginMessageArea = document.getElementById("loginMessageArea");
        const etiquetaForm = document.getElementById("etiquetaForm");
        const messageArea = document.getElementById("messageArea");
        const predefinicaoForm = document.getElementById("predefinicaoForm");
        const messagePredefinicaoArea = document.getElementById("messagePredefinicaoArea");
        const listaPredefinicoesDiv = document.getElementById("listaPredefinicoes");
        const predefinicaoIdInput = document.getElementById("predefinicao_id");
        const nomePredefinicaoInput = document.getElementById("nome_predefinicao");
        const predefNomeProdutoInput = document.getElementById("predef_nome_produto");
        const predefTamanhoEtiquetaSelect = document.getElementById("predef_tamanho_etiqueta");
        const cancelEditPredefinicaoBtn = document.getElementById("cancelEditPredefinicao");

        // Estado da aplicação
        let currentUser = null;

        // Verificar autenticação ao carregar a página
        document.addEventListener("DOMContentLoaded", checkAuthentication);

        // Função para verificar autenticação
        async function checkAuthentication() {
            try {
                const response = await fetch(`${AUTH_API_URL}/check-auth`);
                const data = await response.json();
                
                if (data.authenticated) {
                    // Usuário autenticado
                    currentUser = data.user;
                    showAuthenticatedUI();
                } else {
                    // Usuário não autenticado
                    showLoginUI();
                }
            } catch (error) {
                console.error("Erro ao verificar autenticação:", error);
                showLoginUI();
            }
        }

        // Mostrar UI para usuários autenticados
        function showAuthenticatedUI() {
            loginSection.style.display = "none";
            mainContent.style.display = "block";
            userMenu.style.display = "flex";
            
            // Configurar menu do usuário
            userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
            userName.textContent = currentUser.nome_completo || currentUser.username;
            
            // Carregar dados
            carregarPredefinicoes();
        }

        // Mostrar UI de login
        function showLoginUI() {
            loginSection.style.display = "block";
            mainContent.style.display = "none";
            userMenu.style.display = "none";
            currentUser = null;
        }

        // Login
        loginForm.addEventListener("submit", async function(event) {
            event.preventDefault();
            showMessage(loginMessageArea, "Autenticando...", "info");
            
            const credentials = {
                username: document.getElementById("username").value,
                password: document.getElementById("password").value
            };
            
            try {
                const response = await fetch(`${AUTH_API_URL}/login`, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(credentials)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    showMessage(loginMessageArea, "Login realizado com sucesso!", "success");
                    setTimeout(() => {
                        showAuthenticatedUI();
                    }, 1000);
                } else {
                    throw new Error(data.error || "Erro ao fazer login");
                }
            } catch (error) {
                console.error("Erro de login:", error);
                showMessage(loginMessageArea, error.message, "error");
            }
        });

        // Logout
        logoutBtn.addEventListener("click", async function() {
            try {
                await fetch(`${AUTH_API_URL}/logout`, {
                    method: "POST"
                });
                showLoginUI();
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
            }
        });

        // Gerar etiqueta
        etiquetaForm.addEventListener("submit", function(event) {
            event.preventDefault();
            showMessage(messageArea, "", "none");

            const dataFabricacaoRaw = document.getElementById("data_fabricacao").value;
            const dataValidadeRaw = document.getElementById("data_validade").value;

            const formData = {
                nome_produto: document.getElementById("nome_produto").value,
                data_fabricacao: formatDateToISO(dataFabricacaoRaw),
                data_validade: formatDateToISO(dataValidadeRaw),
                tamanho_etiqueta: document.getElementById("tamanho_etiqueta").value
            };

            // Validação simples no frontend para garantir que as datas foram convertidas
            if (!formData.data_fabricacao.match(/^\d{4}-\d{2}-\d{2}$/) || !formData.data_validade.match(/^\d{4}-\d{2}-\d{2}$/)) {
                showMessage(messageArea, "Formato de data inválido após tentativa de conversão. Use YYYY-MM-DD.", "error");
                return;
            }

            showMessage(messageArea, "Gerando etiqueta, aguarde...", "info");
            
            fetch(`${API_URL}/etiquetas`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(formData)
            })
            .then(async response => {
                if (response.status === 401) {
                    // Não autenticado, redirecionar para login
                    const errorData = await response.json();
                    showMessage(messageArea, "Sessão expirada. Por favor, faça login novamente.", "error");
                    setTimeout(() => {
                        showLoginUI();
                    }, 2000);
                    throw new Error("Sessão expirada");
                }
                
                if (response.ok) {
                    // Verifica o tipo de conteúdo da resposta
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.includes("application/pdf")) {
                        // Se for PDF, processa como blob para download
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.style.display = "none";
                        a.href = url;
                        const contentDisposition = response.headers.get("content-disposition");
                        let fileName = "etiqueta.pdf";
                        if (contentDisposition) {
                            const fileNameMatch = contentDisposition.match(/filename[^;=\n]*=(([""]).*?\2|[^;\n]*)/);
                            if (fileNameMatch && fileNameMatch[1]) {
                                fileName = fileNameMatch[1].replace(/[""]/g, '');
                            }
                        }
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        showMessage(messageArea, "Etiqueta PDF gerada e download iniciado!", "success");
                        etiquetaForm.reset();
                    } else {
                        // Se não for PDF, tenta processar como JSON (caso de sucesso não-PDF)
                        try {
                            const data = await response.json();
                            showMessage(messageArea, data.message || "Operação realizada com sucesso!", "success");
                        } catch (e) {
                            // Se não conseguir processar como JSON, mostra mensagem genérica de sucesso
                            showMessage(messageArea, "Operação realizada com sucesso!", "success");
                        }
                    }
                } else {
                    // Em caso de erro, tenta processar como JSON
                    try {
                        const errorData = await response.json();
                        throw new Error(errorData.error || "Erro ao gerar etiqueta.");
                    } catch (jsonError) {
                        // Se não conseguir processar o erro como JSON, mostra o status HTTP
                        throw new Error(`Erro ao gerar etiqueta. Status: ${response.status}`);
                    }
                }
            })
            .catch(error => {
                if (error.message !== "Sessão expirada") {
                    console.error("Erro ao gerar etiqueta:", error);
                    showMessage(messageArea, error.message, "error");
                }
            });
        });

        // Carregar pré-definições
        async function carregarPredefinicoes() {
            try {
                const response = await fetch(`${API_URL}/predefinicoes`);
                
                if (response.status === 401) {
                    // Não autenticado, redirecionar para login
                    showMessage(messagePredefinicaoArea, "Sessão expirada. Por favor, faça login novamente.", "error");
                    setTimeout(() => {
                        showLoginUI();
                    }, 2000);
                    return;
                }
                
                if (!response.ok) throw new Error("Erro ao carregar pré-definições.");
                
                const predefinicoes = await response.json();
                listaPredefinicoesDiv.innerHTML = ""; 
                if (predefinicoes.length === 0) {
                    listaPredefinicoesDiv.innerHTML = "<p style='text-align: center; grid-column: 1 / -1;'>Nenhuma pré-definição salva ainda.</p>";
                    return;
                }
                predefinicoes.forEach(p => {
                    const itemDiv = document.createElement("div");
                    itemDiv.className = "predefinicao-item";
                    itemDiv.innerHTML = `
                        <div class="predefinicao-header">
                            <h3 class="predefinicao-title">${p.nome_predefinicao}</h3>
                        </div>
                        <div class="predefinicao-details">
                            <p><strong>Produto:</strong> ${p.nome_produto}</p>
                            <p><strong>Tamanho:</strong> ${p.tamanho_etiqueta}</p>
                        </div>
                        <div class="predefinicao-actions">
                            <button onclick="usarPredefinicao('${p.nome_produto}', '${p.tamanho_etiqueta}')" class="btn">Usar</button>
                            <button onclick="editarPredefinicao(${p.id}, '${p.nome_predefinicao}', '${p.nome_produto}', '${p.tamanho_etiqueta}')" class="btn btn-secondary">Editar</button>
                            <button onclick="excluirPredefinicao(${p.id})" class="btn btn-danger">Excluir</button>
                        </div>
                    `;
                    listaPredefinicoesDiv.appendChild(itemDiv);
                });
            } catch (error) {
                console.error("Erro ao carregar pré-definições:", error);
                listaPredefinicoesDiv.innerHTML = `<p class="error" style="text-align: center; grid-column: 1 / -1;">${error.message}</p>`;
            }
        }

        // Usar pré-definição
        window.usarPredefinicao = function(nomeProduto, tamanhoEtiqueta) {
            document.getElementById("nome_produto").value = nomeProduto;
            document.getElementById("tamanho_etiqueta").value = tamanhoEtiqueta;
            // Limpar campos de data para que o usuário preencha novamente
            document.getElementById("data_fabricacao").value = ''; 
            document.getElementById("data_validade").value = '';
            document.getElementById("data_fabricacao").focus();
            
            // Scroll suave até o formulário
            document.getElementById('formulario').scrollIntoView({
                behavior: 'smooth'
            });
        }

        // Editar pré-definição
        window.editarPredefinicao = function(id, nomePredef, nomeProd, tamanho) {
            predefinicaoIdInput.value = id;
            nomePredefinicaoInput.value = nomePredef;
            predefNomeProdutoInput.value = nomeProd;
            predefTamanhoEtiquetaSelect.value = tamanho;
            cancelEditPredefinicaoBtn.style.display = "block";
            predefinicaoForm.querySelector('button[type="submit"]').textContent = "Atualizar Pré-definição";
            nomePredefinicaoInput.focus();
            
            // Scroll suave até o formulário de edição
            predefinicaoForm.scrollIntoView({
                behavior: 'smooth'
            });
        }

        // Cancelar edição
        cancelEditPredefinicaoBtn.addEventListener("click", function(){
            predefinicaoForm.reset();
            predefinicaoIdInput.value = "";
            cancelEditPredefinicaoBtn.style.display = "none";
            predefinicaoForm.querySelector('button[type="submit"]').textContent = "Salvar Pré-definição";
        });

        // Excluir pré-definição
        window.excluirPredefinicao = async function(id) {
            if (!confirm("Tem certeza que deseja excluir esta pré-definição?")) return;
            try {
                const response = await fetch(`${API_URL}/predefinicoes/${id}`, { method: "DELETE" });
                
                if (response.status === 401) {
                    // Não autenticado, redirecionar para login
                    showMessage(messagePredefinicaoArea, "Sessão expirada. Por favor, faça login novamente.", "error");
                    setTimeout(() => {
                        showLoginUI();
                    }, 2000);
                    return;
                }
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || "Erro ao excluir pré-definição.");
                }
                showMessage(messagePredefinicaoArea, "Pré-definição excluída com sucesso!", "success");
                carregarPredefinicoes(); // Recarregar lista
            } catch (error) {
                console.error("Erro ao excluir pré-definição:", error);
                showMessage(messagePredefinicaoArea, error.message, "error");
            }
        }

        // Salvar/atualizar pré-definição
        predefinicaoForm.addEventListener("submit", async function(event) {
            event.preventDefault();
            showMessage(messagePredefinicaoArea, "", "none");
            const id = predefinicaoIdInput.value;
            const url = id ? `${API_URL}/predefinicoes/${id}` : `${API_URL}/predefinicoes`;
            const method = id ? "PUT" : "POST";

            const formData = {
                nome_predefinicao: nomePredefinicaoInput.value,
                nome_produto: predefNomeProdutoInput.value,
                tamanho_etiqueta: predefTamanhoEtiquetaSelect.value
            };

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(formData)
                });
                
                if (response.status === 401) {
                    // Não autenticado, redirecionar para login
                    showMessage(messagePredefinicaoArea, "Sessão expirada. Por favor, faça login novamente.", "error");
                    setTimeout(() => {
                        showLoginUI();
                    }, 2000);
                    return;
                }
                
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || `Erro ao ${id ? 'atualizar' : 'salvar'} pré-definição.`);
                }
                showMessage(messagePredefinicaoArea, `Pré-definição ${id ? 'atualizada' : 'salva'} com sucesso!`, "success");
                predefinicaoForm.reset();
                predefinicaoIdInput.value = "";
                cancelEditPredefinicaoBtn.style.display = "none";
                predefinicaoForm.querySelector('button[type="submit"]').textContent = "Salvar Pré-definição";
                carregarPredefinicoes(); // Recarregar lista
            } catch (error) {
                console.error("Erro no formulário de pré-definição:", error);
                showMessage(messagePredefinicaoArea, error.message, "error");
            }
        });

        // Função para exibir mensagens
        function showMessage(area, text, type) {
            area.textContent = text;
            area.className = `message ${type}`;
            area.style.display = text ? "block" : "none";
        }

        // Smooth scroll para links internos
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
    </script>
</body>
</html>
